import{fileURLToPath as Y}from"url";import tt from"path";var et=()=>Y(import.meta.url),rt=()=>tt.dirname(et()),f=rt();import G from"path";import W from"fs/promises";import q from"picocolors";var A="vite-bundle-analyzer";import L from"fs/promises";import O from"path";import at from"fast-glob";import I from"zlib";import it from"util";import F from"path";function C(e){let t=["Bytes","KB","MB","GB","TB"];if(!e)return"0 "+t[0];let s=parseInt(`${Math.floor(Math.log(e)/Math.log(1024))}`);return(e/(1<<s*10)).toFixed(2)+" "+t[s]}function y(e,t){return t.reduce((s,r)=>(s[r]=e[r],s),{})}var nt=it.promisify(I.gzip),ot={level:I.constants.Z_DEFAULT_LEVEL},g=b(F.join(f,"client")),E=F.join(g,"assets");function $(e={}){return e=Object.assign(ot,e),t=>nt(t,e)}function b(e){return/^\\\\\?\\/.test(e)?e:e.replace(/\\/g,"/")}function z(e){let t=e.injectTo==="head"?/([ \t]*)<\/head>/i:/([ \t]*)<\/body>/i;return e.html.replace(t,s=>`${e.descriptors.join(` `)}${s}`)}async function R(e,t){let s=at.sync(b(O.join(E,"*"))),a=(await Promise.all(s.map(async o=>{let l=O.extname(o).replace(".",""),n=await L.readFile(o,"utf8");return{fileType:l,content:n}}))).filter(o=>["js","css"].includes(o.fileType)),i=await L.readFile(O.join(g,"index.html"),"utf8");return i=i.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,""),i=i.replace(/<link\b[^>]*rel="stylesheet"[^>]*>/gi,""),i=i.replace(/<title>(.*?)<\/title>/,`<title>${t.title}</title>`),i=z({html:i,injectTo:"head",descriptors:a.map(({fileType:o,content:l})=>o==="js"?`<script>${l}</script>`:`<style>${l}</style>`)}),i=z({html:i,injectTo:"body",descriptors:[`<script> window.defaultSizes = ${JSON.stringify(t.mode)}; window.foamModule = ${JSON.stringify(e)}; </script>`]}),i}import K from"path";import{SourceMapConsumer as H}from"source-map";var lt=b(process.cwd());function pt(e){return e=b(e),e.replace(lt,"").replace(/\0/,"")}function ut(e){let t=e.split("/");if(t.length===1)return t;let s=[],r=t.pop();for(;t.length;){let a=t.shift();s.push(a)}return[s,r]}function j(e){let t=pt(e);return K.isAbsolute(t)?t.replace("/",""):t}async function ct(e,t){let s={};return t?(await H.with(t,null,r=>{let a=1,i=0;for(let o=0;o<e.length;o++,i++){let{source:l}=r.originalPositionFor({line:a,column:i});if(l){let n=l.replace(/\.\.\//g,"");n in s?s[n]+=e[o]:s[n]=e[o]}e[o]===` `&&(a+=1,i=-1)}}),s):{}}var S=class{id;label;path;pairs;pairIds;groups;constructor(t){this.id=t,this.label=t,this.path=t,this.pairs=Object.create(null),this.groups=[],this.pairIds=[]}addPairsNode(t,s){this.pairs[t]||(s.label=t,s.path=t,this.pairs[t]=s,this.pairIds.push(t))}addPairs(t){return this.pairs[t.id]=t,this.pairIds.push(t.id),t}getChild(t){return this.pairs[t]}},x=class extends S{parsedSize;gzipSize;constructor(t,s,r){super(t),this.parsedSize=s,this.gzipSize=r}};function v(e,t,s){return new x(j(e),t,s)}var N=class extends S{statSize;constructor(t,s){super(t),this.statSize=s}};function _(e,t){return new N(j(e),t)}var B=class extends S{parsedSize;mapSize;statSize;gzipSize;source;stats;pairs;imports;isAsset;isEntry;currentNodeKind;constructor(t){super(t),this.parsedSize=0,this.statSize=0,this.gzipSize=0,this.mapSize=0,this.source=[],this.stats=[],this.pairs=Object.create(null),this.imports=new Set,this.isAsset=!0,this.isEntry=!1,this.currentNodeKind="stat"}processTreeNode(t,s){let r=ut(t.id);if(r.length===1){this.addPairsNode(t.id,t);return}let[a,i]=r,o=this;a.forEach(l=>{let n=o.getChild(l);n||(n=o.addPairs(s==="stat"?_(l,0):v(l,0,0))),o=n}),i&&o.addPairsNode(i,t)}addImports(...t){t.forEach(s=>this.imports.add(s))}async setup(t,s,r){let a=t.modules,i=Buffer.from(t.code,"utf8"),o=await r(i);this.gzipSize=o.byteLength,this.parsedSize=i.byteLength,t.map&&(this.mapSize=Buffer.from(t.map.toString()).byteLength);let l=await ct(t.code,t.map);for(let u in a){let c=s.getModuleInfo(u);if(!c)continue;let{id:d}=c;if(/\.(mjs|js|ts|vue|jsx|tsx|svelte)(\?.*|)$/.test(d)||d.startsWith("\0")){let m=_(d,a[u].renderedLength);this.statSize+=m.statSize,this.stats.push(m)}}let n=t.moduleIds.filter(u=>u.startsWith("\0")),p={parsedSize:0};for(let u in l){if(!t.moduleIds.length)continue;let c=t.moduleIds.find(d=>d.match(u));if(c){let d=Buffer.from(l[u],"utf8"),m=await r(d);p.parsedSize+=d.byteLength,this.source.push(v(c,d.byteLength,m.byteLength))}}if(n.length>0){let{code:u,map:c}=t,d=c?.sources?.[0];if(d){let m=null;await H.with(t.map,null,Q=>{let k=1,w=0;for(let P=0;P<u.length;P++,w++){let{source:X}=Q.originalPositionFor({line:k,column:w});if(X===d){m=Buffer.from(u.substring(0,w),"utf8");break}u[P]===` `&&(k+=1,w=-1)}});let U=m?(await r(m)).byteLength:0;this.source.push(v("\0virtual-chunks",this.parsedSize-p.parsedSize,U))}}this.source.length||this.source.push(v(this.id,this.parsedSize,this.gzipSize)),this.currentNodeKind="stat",this.stats=this.prepareNestedNodes(this.stats,this.currentNodeKind),this.currentNodeKind="source",this.source=this.prepareNestedNodes(this.source,this.currentNodeKind),this.isEntry=t.isEntry}prepareNestedNodes(t,s){for(;t.length;){let r=t.shift();if(!r)break;this.processTreeNode(r,s)}return this.walk(this,(r,a)=>{a.groups.push(r)}),this.mergeFolder()}walk(t,s){t.pairIds.length&&(t.pairIds.forEach(r=>{if(r in t.pairs){let a=t.pairs[r];s(a,t),this.walk(a,s)}}),t.pairIds=[],t.pairs={})}mergeFolder(){let t=r=>{if(!r.groups.length){if(r instanceof N)return y(r,["id","path","label","statSize"]);if(r instanceof x)return y(r,["id","path","label","parsedSize","gzipSize"])}let a=r.groups.map(t);if(a.length===1&&!K.extname(r.id)){let i={},o=a[0];if(i.id=r.id,i.label=`${r.label}/${o.label}`,i.path=`${r.path}/${o.path}`,r instanceof N)return Object.assign(i,y(o,["statSize","groups"])),i;if(r instanceof x)return Object.assign(i,y(o,["parsedSize","gzipSize","groups"])),i}if(this.currentNodeKind==="stat"){let{statSize:i}=a.reduce((o,l)=>(o.statSize+=l.statSize,o),{statSize:0});return{...y(r,["id","path","label"]),statSize:i,groups:a}}if(this.currentNodeKind==="source"){let{parsedSize:i,gzipSize:o}=a.reduce((l,n)=>(l.parsedSize+=n.parsedSize,l.gzipSize+=n.gzipSize,l),{parsedSize:0,gzipSize:0});return{...y(r,["id","path","label"]),parsedSize:i,gzipSize:o,groups:a}}},s=this.groups.map(r=>t(r));return this.groups=[],s}};function dt(e){return new B(j(e))}var M=class{compress;modules;pluginContext;constructor(t){this.compress=$(t),this.modules=[],this.pluginContext=null}installPluginContext(t){this.pluginContext||(this.pluginContext=t)}async addModule(t,s){let r=dt(t);r.addImports(...s.imports,...s.dynamicImports),await r.setup(s,this.pluginContext,this.compress),this.modules.push(r)}processFoamModule(){let s=(r=>{let a=(i,o=[])=>{let l=[...i.imports].flatMap(p=>this.modules.filter(u=>!o.includes(u.id)&&u.id===j(p))),n=l.map(p=>p.id).concat(o);return l.flatMap(p=>a(p,n)).concat(l)};return r.filter(i=>i.isEntry).reduce((i,o)=>(a(o).forEach(l=>{i[l.id]||(i[l.id]=new Set),i[l.id].add(o.id)}),i),{})})(this.modules);return this.modules.map(r=>({...y(r,["id","label","path","statSize","parsedSize","mapSize","gzipSize","source","stats","isAsset","isEntry"]),imports:Array.from(s[r.id]??[])}))}};function Z(e){return new M(e)}import mt from"http";import ft from"fs";import yt from"path";import ht from"sirv";var gt=ht(g,{dotfiles:!0});function D(e=0){let t=mt.createServer();return t.on("request",(r,a)=>{gt(r,a,()=>{a.statusCode=404,a.end("File not found")})}),t.listen(e,()=>{console.log(`server run on http://localhost:${t.address().port}`)}),{setup:(r,a)=>{t.on("listening",()=>{let i=t.listeners("request");t.removeAllListeners("request"),t.on("request",(o,l)=>{if(o.url==="/"){l.setHeader("Content-Type","text/html; charset=utf8;");let n=ft.readFileSync(yt.join(g,"index.html"),"utf8");n=n.replace(/<title>(.*?)<\/title>/,`<title>${a.title}</title>`),n=z({html:n,injectTo:"body",descriptors:[`<script> window.defaultSizes = ${JSON.stringify(a.mode)}; window.foamModule = ${JSON.stringify(r)}; </script>`]}),l.end(n)}else i.map(n=>n.call(t,o,l))})})},get port(){return t.address().port}}}var bt=!!process.env.CI;async function zt(e){await import("open").then(t=>t.default(e,{newInstance:!0})).catch(()=>{})}var V=e=>q.dim(q.bold(e)),T=e=>V(C(e)),J=e=>{let t=e.length,s=e.reduce((a,i)=>(a.gzip+=i.gzipSize,a.parsed+=i.parsedSize,a.map+=i.mapSize,a),{gzip:0,parsed:0,map:0}),r=[s.gzip&&`gzip: ${T(s.gzip)}`,s.map&&`map: ${T(s.map)}`].filter(Boolean).join(" | ");return`${V(t)} chunks of ${T(s.parsed)} ${r?`(${r})`:""}`};function ne(e={analyzerMode:"server",summary:!0}){let{reportTitle:t=A}=e,s=Z(e?.gzipOptions),r=process.cwd(),a=!1,i=!0,o;return{name:A,apply:"build",enforce:"post",configResolved(n){if(r=n.build.outDir??n.root,o=n.logger,e.summary){let p=n.plugins.find(u=>u.name==="vite:reporter");if(i=!!p?.writeBundle,p?.writeBundle){let u=typeof p.writeBundle=="function"?p.writeBundle:p.writeBundle?.handler,c=async function(...d){await u?.apply(this,d),o.info(J(s.modules))};typeof p.writeBundle!="function"?p.writeBundle.handler=c:p.writeBundle=c}}},config(n){n.build?.sourcemap&&(a=typeof n.build.sourcemap=="boolean"?n.build.sourcemap:n.build.sourcemap==="hidden"),n.build||(n.build={}),n.build.sourcemap="hidden"},async generateBundle(n,p){s.installPluginContext(this);for(let u in p){let c=p[u];c.type==="chunk"&&(await s.addModule(u,c),!a&&c.sourcemapFileName&&Reflect.deleteProperty(p,c.sourcemapFileName))}},async closeBundle(){switch(e.summary&&!i&&o.info(J(s.modules)),e.analyzerMode){case"json":{let n=G.join(r,e.fileName?`${e.fileName}.json`:"stats.json"),p=s.processFoamModule();W.writeFile(n,JSON.stringify(p,null,2),"utf8");break}case"static":{let n=G.join(r,e.fileName?`${e.fileName}.html`:"stats.html"),p=s.processFoamModule(),u=await R(p,{title:t,mode:"stat"});W.writeFile(n,u,"utf8");break}case"server":{let n=s.processFoamModule(),{setup:p,port:u}=D((e.analyzerPort==="atuo"?0:e.analyzerPort)??8888);if(p(n,{title:t,mode:"stat"}),(e.openAnalyzer??!0)&&!bt){let c=`http://localhost:${u}`;await zt(c)}break}default:throw new Error("Invalidate Option `analyzerMode`")}}}}export{ne as analyzer,ne as default};
